import type {
    FormData as RecipeFormData,
    FormDataImage,
    FormDataStep,
} from "../../types/admin";
import { sortImagesByOrder } from "../../utils/imageUtils";
import {
    SubSection,
    SubSectionTitle,
    StepImageContainer,
    StepImageGrid,
    ImagePreview,
    Input,
    FormGroup,
    Label,
} from "../../styles/pages/Admin.styles";

interface ImageManagerProps {
    formData: RecipeFormData;
    setFormData: React.Dispatch<React.SetStateAction<RecipeFormData>>;
    removeImage: (index: number) => void;
    getImageUrl: (image: FormDataImage) => string;
}

const ImageManager: React.FC<ImageManagerProps> = ({
    formData,
    setFormData,
    removeImage,
    getImageUrl,
}) => {
    const updateStepField = (stepIndex: number, field: keyof FormDataStep, value: string) => {
        const newSteps = [...formData.steps];
        newSteps[stepIndex] = { ...newSteps[stepIndex], [field]: value };
        setFormData({ ...formData, steps: newSteps });
    };

    const getImagesByStep = () => {
        const stepImages: { [key: number]: FormDataImage[] } = {};

        formData.images.forEach((image) => {
            if (image.step_number) {
                if (!stepImages[image.step_number]) {
                    stepImages[image.step_number] = [];
                }
                stepImages[image.step_number].push(image);
            }
        });

        // Í∞Å Îã®Í≥ÑÏùò Ïù¥ÎØ∏ÏßÄÎ•º image_order ÏàúÏÑúÎåÄÎ°ú Ï†ïÎ†¨
        Object.keys(stepImages).forEach((stepNum: string) => {
            stepImages[parseInt(stepNum)] = sortImagesByOrder<FormDataImage>(stepImages[parseInt(stepNum)]);
        });

        return stepImages;
    };

    const processFiles = (files: File[], stepNumber: number, slotIndex: number) => {
        const imageFiles = files.filter((file: File) => file.type.startsWith("image/"));

        // ÌòÑÏû¨ Îã®Í≥ÑÏùò Ïù¥ÎØ∏ÏßÄ Í∞úÏàò ÌôïÏù∏
        const currentStepImages = formData.images.filter(img => img.step_number === stepNumber);

        // ÏµúÎåÄ 5Í∞úÍπåÏßÄÏßÄÎßå, Îπà Ïä¨Î°ØÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if (currentStepImages.length >= 5) {
            alert("Ïù¥ Îã®Í≥ÑÏùò Ïù¥ÎØ∏ÏßÄ Ïä¨Î°ØÏù¥ Î™®Îëê Ï∞ºÏäµÎãàÎã§.");
            return;
        }

        // Ï≤´ Î≤àÏß∏ ÌååÏùºÎßå Ï≤òÎ¶¨
        const file = imageFiles[0];
        if (!file) return;

        // Ìï¥Îãπ Îã®Í≥ÑÏùò authorÏôÄ license Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const stepData = formData.steps.find(step => step.step_number === stepNumber);

        const reader = new FileReader();
        reader.onload = (e) => {
            const imageUrl = e.target?.result as string;
            const newImage: FormDataImage = {
                folder: "uploads",
                file_name: file.name,
                step_number: stepNumber,
                image_order: slotIndex + 1, // Ïä¨Î°Ø Î≤àÌò∏Î•º image_orderÎ°ú Ï†ÄÏû• (1-based)
                preview: imageUrl,
                file: file,
                provider: stepData?.author || "",
                imageLicense: stepData?.license || "",
            };

            setFormData((prev) => ({
                ...prev,
                images: [...prev.images, newImage],
            }));
        };
        reader.readAsDataURL(file);
    };

    const stepImages = getImagesByStep();

    return (
        <SubSection>
            <SubSectionTitle>üì∏ Îã®Í≥ÑÎ≥Ñ Î†àÏãúÌîº Ïù¥ÎØ∏ÏßÄ</SubSectionTitle>

            {/* Îã®Í≥ÑÎ≥Ñ Ïù¥ÎØ∏ÏßÄ */}
            {formData.steps.map((step: FormDataStep) => {
                const currentStepImages = stepImages[step.step_number] || [];

                return (
                    <StepImageContainer key={step.step_number}>
                        <div className="step-header">
                            <div className="step-badge">{step.step_number}</div>
                            <div className="step-title">Îã®Í≥Ñ {step.step_number}</div>
                            <div className="image-count">{currentStepImages.length}/5</div>
                        </div>

                        
                        <StepImageGrid>
                            {/* Ìï≠ÏÉÅ 5Í∞úÏùò Ïä¨Î°Ø ÌëúÏãú */}
                            {[0, 1, 2, 3, 4].map((slotIndex: number) => {
                                const image = currentStepImages[slotIndex];

                                return (
                                    <ImagePreview key={`step-${step.step_number}-slot-${slotIndex}`}>
                                        {image ? (
                                            <>
                                                <img
                                                    src={getImageUrl(image)}
                                                    alt={image.file_name}
                                                    onError={(e) => {
                                                        e.currentTarget.src = "/images/placeholder.png";
                                                    }}
                                                />
                                                <div className="image-info">
                                                    <div className="filename">{image.file_name}</div>
                                                    <div className="step-info">
                                                        Îã®Í≥Ñ {step.step_number} - {slotIndex + 1}Î≤àÏß∏
                                                    </div>
                                                </div>
                                                <button
                                                    className="remove-image"
                                                    onClick={() => removeImage(formData.images.indexOf(image))}
                                                    title="Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú"
                                                >
                                                    √ó
                                                </button>
                                            </>
                                        ) : (
                                            <div
                                                style={{
                                                    width: "100%",
                                                    height: "100%",
                                                    display: "flex",
                                                    flexDirection: "column",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    cursor: "pointer",
                                                    border: "2px dashed #ccc",
                                                    borderRadius: "8px",
                                                    transition: "all 0.3s ease",
                                                    position: "relative"
                                                }}
                                                onClick={() => {
                                                    const input = document.createElement("input");
                                                    input.type = "file";
                                                    input.accept = "image/*";
                                                    input.onchange = (e) => {
                                                        const files = Array.from((e.target as HTMLInputElement).files || []);
                                                        if (files.length > 0) {
                                                            processFiles(files, step.step_number, slotIndex);
                                                        }
                                                    };
                                                    input.click();
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.borderColor = "#667eea";
                                                    e.currentTarget.style.backgroundColor = "#f8f9fa";
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.borderColor = "#ccc";
                                                    e.currentTarget.style.backgroundColor = "transparent";
                                                }}
                                            >
                                                {/* Ïä¨Î°Ø Î≤àÌò∏ */}
                                                <div style={{
                                                    position: "absolute",
                                                    top: "8px",
                                                    left: "8px",
                                                    background: "#667eea",
                                                    color: "white",
                                                    width: "24px",
                                                    height: "24px",
                                                    borderRadius: "50%",
                                                    display: "flex",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    fontSize: "0.8rem",
                                                    fontWeight: "bold"
                                                }}>
                                                    {slotIndex + 1}
                                                </div>

                                                <div style={{
                                                    fontSize: "2rem",
                                                    color: "#ccc",
                                                    marginBottom: "0.5rem"
                                                }}>
                                                    +
                                                </div>
                                                <div style={{
                                                    fontSize: "0.8rem",
                                                    color: "#999",
                                                    textAlign: "center"
                                                }}>
                                                    Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
                                                </div>
                                            </div>
                                        )}
                                    </ImagePreview>
                                );
                            })}
                        </StepImageGrid>

                        {/* Ïù¥ÎØ∏ÏßÄ Ïä¨Î°ØÏóêÏÑú ÏßÅÏ†ë Ï∂îÍ∞ÄÌïòÎØÄÎ°ú Î≤ÑÌäº Î∂àÌïÑÏöî */}

                        {/* Îã®Í≥ÑÎ≥Ñ Ï†úÍ≥µÏûê/ÎùºÏù¥ÏÑ†Ïä§ ÏûÖÎ†• Ïπ∏ */}
                        <div style={{ marginTop: "1rem", padding: "1rem", border: "1px solid #e0e0e0", borderRadius: "8px", backgroundColor: "#f8f9fa" }}>
                            <h5 style={{ margin: "0 0 0.5rem 0", color: "#333" }}>üìù Îã®Í≥Ñ {step.step_number} Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥</h5>
                            <FormGroup>
                                <Label>Ïù¥ÎØ∏ÏßÄ Ï†úÍ≥µÏûê</Label>
                                <Input
                                    type="text"
                                    value={step.author || ""}
                                    onChange={(e) => updateStepField(formData.steps.indexOf(step), "author", e.target.value)}
                                    placeholder="Ïòà: OO Ïú†ÌäúÎ∏å Ï±ÑÎÑê, OO ÏöîÎ¶¨ÏÇ¨"
                                />
                            </FormGroup>
                            <FormGroup>
                                <Label>Ïù¥ÎØ∏ÏßÄ ÎùºÏù¥ÏÑ†Ïä§</Label>
                                <Input
                                    type="text"
                                    value={step.license || ""}
                                    onChange={(e) => updateStepField(formData.steps.indexOf(step), "license", e.target.value)}
                                    placeholder="Ïòà: CC BY-SA 4.0, Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∂úÏ≤ò Î™ÖÏãú"
                                />
                            </FormGroup>
                        </div>
                    </StepImageContainer>
                );
            })}

  
            {/* ÎèÑÏõÄÎßê */}
            <div>
                <h4>üí° Ïù¥ÎØ∏ÏßÄ Í¥ÄÎ¶¨ ÌåÅ</h4>
                <ul>
                    <li><strong>Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïãú:</strong> Ï†úÍ≥µÏûêÏôÄ ÎùºÏù¥ÏÑ†Ïä§ Ï†ïÎ≥¥Î•º Î∞òÎìúÏãú ÏûÖÎ†•Ìï¥Ïïº Ìï©ÎãàÎã§</li>
                    <li><strong>Îã®Í≥ÑÎ≥Ñ Ïù¥ÎØ∏ÏßÄ:</strong> Í∞Å Ï°∞Î¶¨ Îã®Í≥ÑÎ≥ÑÎ°ú ÏµúÎåÄ 5Í∞úÏùò Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä Í∞ÄÎä•</li>
                    <li><strong>Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä Î∞©Î≤ï:</strong> ÎπÑÏñ¥ÏûàÎäî Ïä¨Î°Ø( + Î≤ÑÌäº)ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</li>
                    <li><strong>Ï†úÍ≥µÏûê/ÎùºÏù¥ÏÑ†Ïä§:</strong> Í∞Å Îã®Í≥ÑÎ≥ÑÎ°ú Ïù¥ÎØ∏ÏßÄ Ï†úÍ≥µÏûêÏôÄ ÎùºÏù¥ÏÑ†Ïä§ Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§</li>
                    <li><strong>Ïù¥ÎØ∏ÏßÄ ÌòïÏãù:</strong> JPG, PNG, GIF ÏßÄÏõê ‚Ä¢ ÏµúÎåÄ 10MB</li>
                    <li><strong>Ï†ÄÏûëÍ∂å Ï§ÄÏàò:</strong> Îã§Î•∏ ÏòÅÏÉÅÏùò Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÏÇ¨Ïö© Ïãú Î∞òÎìúÏãú Ï∂úÏ≤òÏôÄ ÎùºÏù¥ÏÑ†Ïä§Î•º Î™ÖÏãúÌï¥Ïïº Ìï©ÎãàÎã§</li>
                </ul>
            </div>
        </SubSection>
    );
};

export default ImageManager;